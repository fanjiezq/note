# 基本介绍
+ Elasticsearch 是一个面向文档的 nosql 数据库
+ 与关系型数据库将数据扁平化不同，它以对象的形式存储数据，一个文档就是一个对象，数据本身包含了对象的结构信息


# 基础概念
+ 索引(index): es 的一个存储层级，类似mysql中的数据库，它只是一个逻辑概念，用于将一类数据放在一起管理
+ 类型(type):比索引低一级的存储层级，类似mysql的表，表示一个数据对象的类别。因为index的类别一般比较宽泛，为了管理方便，其下层可以细化出更多类别
+ 文档(doc):es存储体系中的最基本单位，es通常存储的都是结构化的对象数据，这些对象被序列化成 JSON 并存储到 Elasticsearch 中，指定了唯一ID，所以从某种意义上说，一个文档也可以看作一个JSON对象。一个文档的 _index 、_type、_id 唯一标识一个文档
+ 文档元数据:文档内部保存的是对象的序列化数据，但是文档本身也存在数据(_index,_type,id等),

# 数据安全
## 集群
+ es 可以单节点部署也可以集群部署，集群模式下es采用主从架构，一个主节点多个从节点
+ 主节点负责管理集群范围内的所有变更，例如增加、删除索引，或者增加、删除节点等，但是主节点不会负责到文档级别的变更，这保证了主节点的压力不至于很大成为集群性能瓶颈。集群中的任何节点都可能被选举为主节点
+ 集群中的任何节点都知道集群中所有数据的位置，所以客户端可以通过任何节点检索获取数据，这也意味着集群的性能会随着集群节点的增多变大 
+ 从节点除了可以提升系统性能，也是容错的手段，主节点宕机以后，从节点会立即选举出新的主节点对集群进行管理

## 数据分片
+ es中的数据是以分片形式管理的，每个分片都是一个文档集合，分片分为主分片和分片副本，主分片负责文档的存储和文档检索，分片副本保持与主分片数据同步。我们可以为每个index设置主分片个数和每个分片副本个数
+ 分片副本有两个作用，一是进行故障转移，主分片数据不可使用后副本可以立即升级为主分片，二是副本分片本身可以对外服务，分摊数据查询压力
+ 每个分片的存储的文档数量有限，所以index的分片数量决定了这个index存储的最大数据量，主分片的数目在索引创建时就已经确定了下来了，后期不可更改，所以在建立index时要做好规划，但是分片副本数量是可以动态扩容的
+ 存储文档时，如何决定某个文档存储在哪个分片，存储后又如何定位呢。es采用算法(shard = hash(docId) % number_of_primary_shards)存储和定位文档.所以index的猪分片一旦确定就不能再更改，否则文档就无法找到了

# 操作流程
## 写操作流程(新建文档，更新文档和删除文档都属于写操作)
1. 客户端可以连接到集群中的任意节点，集群中的每个节点都知道所有分片所在节点位置。所以该节点可以根据id计算出文档所属的主分片，并负责后续的数据请求和返回，接收请求的节点被成为协调节点
2. 定位到主分片后，节点会将请求转发到该分片所属节点，节点对主分片进行写操作，如果完成，该节点会将请求转发到当前主分片的副本分配所在节点进行同样的操作。当所有分片副本都完成写操作，主节点将结果返回给协调节点，协调节点返回给客户端
3. 我们注意到数据的分片副本可能是很多的，每个写操作要求所有分片副本都写完成才返回请求结果，性能可能不会很高，所以我们也可以牺牲一部分数据安全性提升性能。通过设置 consistency 参数决定至少多少节点写成功以后就可以返回请求结果了。为了保证网络出现分区错误导致数据不一致的情况，一般设置为 (分片数量 / 2 + 1 )
4. 如果在写操作过程中出现分片失效，写成功的分片数量不能满足要求，写请求会被阻塞，等待足够的分片可用。等待时间可以设置 

## 读操作流程
1. 任何节点都知道集群的所有分片(包括主分片和分片副本)所在位置，所以客户端可以连接到集群的任意节点检索数据。此节点就为协调节点，会根据文档id获取到文档所属分片位置
2. 如果存在多个分片，协调节点会以轮循的方式将请求转发到不同节点请求数据