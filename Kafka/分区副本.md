# 副本
+ 为了保证数据的高可用,kafka一般集群部署,而且为消息添加副本,消息的副本就是分区的拷贝.
+ kafka一般为一个首领副本,多个跟随副本,只有首领副本负责数据的读写,跟随副本的任务只是从首领副本同步数据,和时刻准备接替宕机
+ 如果一个分区存在N个副本,只要还有一个副本还存货,kafka就可以继续提供服务

# 副本同步
+ 跟随副本时时刻刻从首领副本同步数据,保持与首领副本的数据同步,首领副本也会实时监控跟随副本是否还有效,有效的标准有两个
    - 跟随副本还保持这与zk的session
    - 跟随副本的数据与首领副本保持同步,如果跟随副本长时间(10s)没有发发起同步请求,或者请求的不是最新数据,首领副本会认为此副本与自己不同步
+ 对于不同步的副本,首领副本会从将其从同步列表中移除
 
# 首领选举
+ kafka的首领副本崩溃后需要从跟随副本中选举出一个新的首领副本,被选举的跟随副本的数据必须与首领副本的数据一致才能保证数据不丢失,这就牵涉到集群同步问题
+ 集群同步最常用的解决方案是过半节点的提交确认,即类似zk那样使用paxos协议,一个消息只有过半的节点确认的以后才算真正的提交,此方案的缺点是数据的拷贝量比较大,如果集群有五个副本,则必须有三个副本数据拷贝成功以后消息才算确认
+ kafka使用同步列表的方式来选举首领,kafka在zookeeper中维护一个副本列表(in-sync replicas (ISR)),列表中的副本都是与首领副本数据一致的副本,并实时健康,只要列表中某个副本数据不满足要求就移除,选举首领节点的时候就在这个列表中选举.

# 不完全首领选举
+ 生产中可能存在这样一种情况,每个主题的所有跟随副本与首领副本的数据都不同步,且首领副本宕机,此时如果允许跟随副本选举首领,并继续服务,就会出现数据丢失,这就是不完全首领选举.使用unclean.leader.election参数配置,默认true,允许不完全首领选举.针对这种场景,我们只能在集群的可用性和数据不安全性两方作出取舍,要么关闭不完全首领选举,一旦出现这种情况,系统不再对外服务,直到首领副本恢复,要么开启不完全首领选举,忍受数据丢失的风险.
+ 为避免kafka不完全首领选举造成的数据问题,kafka提供最少同步副本配置 min.insync.replicas ,只有指定数量的副本数据同步成功,才进行数据写入
